{% extends 'attendance/base.html' %}

{% block title %}Chấm công - {{ block.super }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title text-center">Chấm công bằng khuôn mặt</h3>
                <p class="text-center" id="currentTime"></p>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div style="position: relative; display: inline-block;">
                        <video id="video" width="640" height="480" autoplay></video>
                        <canvas id="canvas" width="640" height="480"
                            style="position: absolute; top: 0; left: 0;"></canvas>
                    </div>
                </div>
                <div class="text-center">
                    <button id="captureBtn" class="btn btn-primary btn-lg">Chấm công</button>
                </div>
                <div id="result" class="mt-3 text-center"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const resultDiv = document.getElementById('result');
    const currentTimeDiv = document.getElementById('currentTime');
    const ctx = canvas.getContext('2d');

    // Cập nhật đồng hồ thời gian thực
    function updateClock() {
        const now = new Date();
        const options = {
            timeZone: 'Asia/Ho_Chi_Minh',
            hour12: false,
            weekday: 'long',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        currentTimeDiv.textContent = now.toLocaleString('vi-VN', options);
    }

    // Khởi tạo camera
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: "user"
                }
            });
            video.srcObject = stream;
        } catch (err) {
            console.error("Error accessing camera:", err);
            Swal.fire({
                title: 'Lỗi Camera',
                text: 'Không thể truy cập camera. Vui lòng kiểm tra lại quyền truy cập.',
                icon: 'error'
            });
        }
    }

    // Tạo âm thanh thành công (tone dễ chịu)
    function playSuccessSound() {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Tone thành công: C5 -> E5 (523Hz -> 659Hz)
        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(659.25, audioContext.currentTime + 0.1);

        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
    }

    // Tạo âm thanh lỗi (tone cảnh báo)
    function playErrorSound() {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Tone lỗi: F4 -> D4 (349Hz -> 293Hz)
        oscillator.frequency.setValueAtTime(349.23, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(293.66, audioContext.currentTime + 0.15);

        oscillator.type = 'square';
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.4);
    }

    // Xử lý chấm công
    async function processAttendance() {
        // Chụp ảnh từ video
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL('image/jpeg');

        try {
            const response = await fetch('{% url "attendance:process_attendance" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ image: imageData })
            });

            const data = await response.json();
            if (data.success) {
                // Lấy thời gian hiện tại từ DOM
                const currentTime = document.getElementById('currentTime').textContent;

                // Vẽ bounding box nếu có
                if (data.employee.bbox) {
                    const bbox = data.employee.bbox;
                    ctx.beginPath();
                    ctx.lineWidth = "4";
                    ctx.strokeStyle = "green";
                    ctx.rect(bbox[0], bbox[1], bbox[2] - bbox[0], bbox[3] - bbox[1]);
                    ctx.stroke();
                }

                // Phát âm thanh thành công
                playSuccessSound();

                // Hiển thị SweetAlert2 thành công
                Swal.fire({
                    title: data.message,
                    html: `
                        <div class="text-start">
                            <p><strong>Nhân viên:</strong> ${data.employee.name}</p>
                            <p><strong>Phòng ban:</strong> ${data.employee.department}</p>
                            <p><strong>Chức vụ:</strong> ${data.employee.position}</p>
                            <p><strong>Độ chính xác:</strong> ${data.employee.similarity}</p>
                            <p><strong>Thời gian:</strong> ${currentTime}</p>
                            <p><strong>Trạng thái:</strong> ${data.attendance.status}</p>
                        </div>
                    `,
                    icon: 'success',
                    timer: 5000,
                    showConfirmButton: true
                }).then(() => {
                    // Xóa canvas để hiện lại video camera
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                });

                // Xóa kết quả cũ
                resultDiv.innerHTML = '';

            } else {
                // Phát âm thanh lỗi
                playErrorSound();

                Swal.fire({
                    title: 'Chấm công thất bại',
                    text: data.error,
                    icon: 'error',
                    confirmButtonText: 'Thử lại'
                });
            }
        } catch (err) {
            console.error("Error processing attendance:", err);

            // Phát âm thanh lỗi
            playErrorSound();

            Swal.fire({
                title: 'Lỗi hệ thống',
                text: 'Đã xảy ra lỗi khi xử lý chấm công.',
                icon: 'error'
            });
        }
    }

    // Khởi tạo camera và đồng hồ khi trang được load
    document.addEventListener('DOMContentLoaded', () => {
        initCamera();
        updateClock();
        setInterval(updateClock, 1000);  // Cập nhật đồng hồ mỗi giây
    });

    // Xử lý sự kiện nút chấm công
    captureBtn.addEventListener('click', processAttendance);
</script>
{% endblock %}