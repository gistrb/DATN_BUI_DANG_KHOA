{% extends 'attendance/base.html' %}

{% block title %}ƒêƒÉng k√Ω khu√¥n m·∫∑t - {{ block.super }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title text-center">ƒêƒÉng k√Ω khu√¥n m·∫∑t nh√¢n vi√™n</h3>
            </div>
            <div class="card-body">
                <div class="form-group mb-3">
                    <label for="employeeSelect">Ch·ªçn nh√¢n vi√™n:</label>
                    <select class="form-control" id="employeeSelect">
                        <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
                        {% for employee in employees %}
                        <option value="{{ employee.employee_id }}">{{ employee.user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="text-center mb-3" style="position: relative; display: inline-block;">
                    <video id="video" width="640" height="480" autoplay></video>
                    <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
                    <!-- Canvas overlay ƒë·ªÉ v·∫Ω bounding box -->
                    <canvas id="overlay" width="640" height="480"
                        style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>

                    <!-- H∆∞·ªõng d·∫´n t∆∞ th·∫ø hi·ªán t·∫°i -->
                    <div id="poseInstruction" class="alert alert-primary mt-2"
                        style="font-size: 20px; font-weight: bold;">
                        Ch·ªçn nh√¢n vi√™n v√† nh·∫•n "B·∫Øt ƒë·∫ßu thu th·∫≠p"
                    </div>

                    <!-- Feedback t∆∞ th·∫ø -->
                    <div id="poseFeedback" class="mt-2" style="display: none;">
                        <span id="poseStatus" class="badge bg-secondary">
                            <span id="poseIcon">‚è≥</span>
                            <span id="poseText">ƒêang ki·ªÉm tra...</span>
                        </span>
                    </div>
                </div>

                <!-- Progress cho t∆∞ th·∫ø hi·ªán t·∫°i -->
                <div class="progress mb-2" style="height: 20px;">
                    <div id="currentPoseProgress" class="progress-bar bg-info" style="width: 0%;">0/5</div>
                </div>

                <!-- Progress t·ªïng th·ªÉ -->
                <div class="progress mb-3" style="height: 25px;">
                    <div id="totalProgress" class="progress-bar bg-success" style="width: 0%;">0/20</div>
                </div>

                <div class="text-center">
                    <button id="startBtn" class="btn btn-primary btn-lg me-2" disabled>B·∫Øt ƒë·∫ßu thu th·∫≠p</button>
                    <button id="captureBtn" class="btn btn-success btn-lg" disabled style="display: none;">ƒêang thu
                        th·∫≠p...</button>
                </div>

                <div id="result" class="mt-3 text-center"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const employeeSelect = document.getElementById('employeeSelect');
    const resultDiv = document.getElementById('result');
    const poseInstructionDiv = document.getElementById('poseInstruction');
    const poseFeedbackDiv = document.getElementById('poseFeedback');
    const poseStatusSpan = document.getElementById('poseStatus');
    const poseIconSpan = document.getElementById('poseIcon');
    const poseTextSpan = document.getElementById('poseText');
    const currentPoseProgress = document.getElementById('currentPoseProgress');
    const totalProgress = document.getElementById('totalProgress');
    const ctx = canvas.getContext('2d');
    const overlayCtx = overlay.getContext('2d');

    let stream = null;
    let currentStageIndex = 0;
    let currentStageCaptures = 0;
    let allCaptures = [];
    let isDuplicateChecking = false;

    // ƒê·ªãnh nghƒ©a c√°c giai ƒëo·∫°n t∆∞ th·∫ø
    const POSE_STAGES = [
        { pose: 'front', name: 'üì∏ Nh√¨n th·∫≥ng v√†o camera', required: 5, color: '#0d6efd' },
        { pose: 'left', name: '‚Ü™Ô∏è Xoay m·∫∑t sang TR√ÅI nh·∫π', required: 5, color: '#198754' },
        { pose: 'right', name: '‚Ü©Ô∏è Xoay m·∫∑t sang PH·∫¢I nh·∫π', required: 5, color: '#198754' },
        { pose: 'up', name: '‚¨ÜÔ∏è Ng·∫©ng ƒë·∫ßu l√™n nh·∫π', required: 3, color: '#fd7e14' },
        { pose: 'down', name: '‚¨áÔ∏è C√∫i ƒë·∫ßu xu·ªëng nh·∫π', required: 2, color: '#fd7e14' }
    ];

    // Kh·ªüi t·∫°o camera
    async function initCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: "user"
                }
            });
            video.srcObject = stream;
        } catch (err) {
            console.error("Error accessing camera:", err);
            alert("Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng ki·ªÉm tra l·∫°i quy·ªÅn truy c·∫≠p.");
        }
    }

    function updateStageUI() {
        const stage = POSE_STAGES[currentStageIndex];
        poseInstructionDiv.textContent = `${stage.name} (${currentStageCaptures}/${stage.required})`;
        poseInstructionDiv.style.backgroundColor = stage.color;
        poseInstructionDiv.style.color = 'white';
    }

    function updateProgress() {
        const stage = POSE_STAGES[currentStageIndex];

        // Progress t∆∞ th·∫ø hi·ªán t·∫°i
        const stagePercent = (currentStageCaptures / stage.required) * 100;
        currentPoseProgress.style.width = stagePercent + '%';
        currentPoseProgress.textContent = `${currentStageCaptures}/${stage.required}`;

        // Progress t·ªïng th·ªÉ
        const totalPercent = (allCaptures.length / 20) * 100;
        totalProgress.style.width = totalPercent + '%';
        totalProgress.textContent = `${allCaptures.length}/20`;
    }

    function showPoseFeedback(isCorrect, message) {
        if (isCorrect) {
            poseIconSpan.textContent = '‚úÖ';
            poseStatusSpan.className = 'badge bg-success';
        } else {
            poseIconSpan.textContent = '‚ùå';
            poseStatusSpan.className = 'badge bg-warning';
        }
        poseTextSpan.textContent = message;
    }

    function drawBoundingBox(bbox) {
        overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
        overlayCtx.strokeStyle = '#00ff00';
        overlayCtx.lineWidth = 3;
        overlayCtx.strokeRect(bbox[0], bbox[1], bbox[2] - bbox[0], bbox[3] - bbox[1]);
    }

    // H√†m ƒë·ªá quy x·ª≠ l√Ω t·ª´ng frame tu·∫ßn t·ª±
    async function startCapturing() {
        currentStageIndex = 0;
        currentStageCaptures = 0;
        allCaptures = [];
        isDuplicateChecking = false;
        let isRunning = true; // Use local flag to control the loop

        startBtn.style.display = 'none';
        captureBtn.style.display = 'inline-block';
        poseFeedbackDiv.style.display = 'block';

        updateStageUI();
        updateProgress();

        const processFrame = async () => {
            if (!isRunning) return;

            // Ki·ªÉm tra ho√†n th√†nh
            if (currentStageIndex >= POSE_STAGES.length) {
                isRunning = false;
                await registerFaces();
                return;
            }

            // L·∫•y frame hi·ªán t·∫°i
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');

            try {
                // Ki·ªÉm tra t∆∞ th·∫ø
                const response = await fetch('/check-pose/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                const poseData = await response.json();

                if (poseData.success) {
                    const currentStage = POSE_STAGES[currentStageIndex];
                    const detectedPose = poseData.pose_type;

                    // V·∫Ω bounding box
                    drawBoundingBox(poseData.bbox);

                    if (detectedPose === currentStage.pose) {
                        // ‚úÖ ƒê√∫ng t∆∞ th·∫ø - Ch·ª•p!
                        allCaptures.push(imageData);
                        currentStageCaptures++;

                        showPoseFeedback(true, `‚úÖ ƒê√∫ng! (${currentStageCaptures}/${currentStage.required})`);
                        updateProgress();

                        // Ki·ªÉm tra xem ƒë√£ ƒë·ªß m·∫´u cho t∆∞ th·∫ø n√†y ch∆∞a
                        if (currentStageCaptures >= currentStage.required) {
                            // N·∫øu v·ª´a ho√†n th√†nh stage FRONT, ki·ªÉm tra duplicate
                            if (currentStage.pose === 'front' && !isDuplicateChecking) {
                                isDuplicateChecking = true; // ƒê√°nh d·∫•u ƒëang ki·ªÉm tra
                                showPoseFeedback(true, 'üîç ƒêang ki·ªÉm tra tr√πng l·∫∑p...');

                                try {
                                    const checkResponse = await fetch('/check-duplicate/', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ image: imageData })
                                    });

                                    const checkData = await checkResponse.json();

                                    if (checkData.success && checkData.is_duplicate) {
                                        // Khu√¥n m·∫∑t ƒë√£ t·ªìn t·∫°i - d·ª´ng l·∫°i
                                        isRunning = false;

                                        Swal.fire({
                                            title: 'Khu√¥n m·∫∑t ƒë√£ t·ªìn t·∫°i!',
                                            html: `
                                                <p><strong>L·ªói:</strong> Khu√¥n m·∫∑t n√†y ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω trong h·ªá th·ªëng</p>
                                                <p class="mt-2"><strong>Tr√πng v·ªõi nh√¢n vi√™n:</strong></p>
                                                <p>${checkData.employee_name} (${checkData.employee_id})</p>
                                            `,
                                            icon: 'error',
                                            confirmButtonText: 'OK'
                                        });

                                        // Reset UI
                                        captureBtn.style.display = 'none';
                                        startBtn.style.display = 'inline-block';
                                        startBtn.disabled = false;
                                        poseFeedbackDiv.style.display = 'none';
                                        poseInstructionDiv.textContent = 'Ch·ªçn nh√¢n vi√™n v√† nh·∫•n "B·∫Øt ƒë·∫ßu thu th·∫≠p"';
                                        poseInstructionDiv.style.backgroundColor = '';
                                        poseInstructionDiv.className = 'alert alert-primary mt-2';
                                        overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
                                        allCaptures = [];
                                        currentStageIndex = 0;
                                        currentStageCaptures = 0;
                                        updateProgress();
                                        return; // D·ª´ng h·∫≥n
                                    }

                                    // Kh√¥ng tr√πng - ti·∫øp t·ª•c
                                    showPoseFeedback(true, '‚úÖ Kh√¥ng tr√πng - ti·∫øp t·ª•c!');
                                } catch (error) {
                                    console.error('Error checking duplicate:', error);
                                }
                            }

                            // Chuy·ªÉn sang t∆∞ th·∫ø ti·∫øp theo
                            currentStageIndex++;
                            currentStageCaptures = 0;

                            if (currentStageIndex < POSE_STAGES.length) {
                                updateStageUI();
                                // Delay 1 gi√¢y ƒë·ªÉ ng∆∞·ªùi d√πng chu·∫©n b·ªã
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }
                    } else {
                        // ‚ùå Sai t∆∞ th·∫ø
                        showPoseFeedback(false, `‚ùå C·∫ßn: ${currentStage.name}`);
                    }
                } else {
                    showPoseFeedback(false, '‚ùå Kh√¥ng ph√°t hi·ªán khu√¥n m·∫∑t');
                    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
                }
            } catch (error) {
                console.error('Error checking pose:', error);
                showPoseFeedback(false, '‚ùå L·ªói ki·ªÉm tra t∆∞ th·∫ø');
            }

            // G·ªçi ƒë·ªá quy sau 500ms
            if (isRunning) {
                setTimeout(processFrame, 500);
            }
        };

        // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p
        processFrame();
    }

    async function registerFaces() {
        const employeeId = employeeSelect.value;
        if (!employeeId) {
            alert("Vui l√≤ng ch·ªçn nh√¢n vi√™n");
            return;
        }

        captureBtn.disabled = true;
        captureBtn.textContent = 'ƒêang x·ª≠ l√Ω...';

        try {
            const response = await fetch('{% url "attendance:register_face" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    employee_id: employeeId,
                    images: allCaptures
                })
            });

            const data = await response.json();
            if (data.success) {
                const now = new Date();
                const options = {
                    timeZone: 'Asia/Ho_Chi_Minh',
                    weekday: 'long',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };

                resultDiv.innerHTML = '';

                Swal.fire({
                    title: data.message,
                    html: `
                    <div class="text-start">
                        <h5>Th√¥ng tin ƒëƒÉng k√Ω:</h5>
                        <p><strong>M√£ nh√¢n vi√™n:</strong> ${data.employee.id}</p>
                        <p><strong>H·ªç v√† t√™n:</strong> ${data.employee.name}</p>
                        <p><strong>Ph√≤ng ban:</strong> ${data.employee.department}</p>
                        <p><strong>Ch·ª©c v·ª•:</strong> ${data.employee.position}</p>
                        <p><strong>S·ªë m·∫´u ƒë√£ l∆∞u:</strong> ${data.samples_count} m·∫´u</p>
                        <p><strong>Th·ªùi gian:</strong> ${now.toLocaleString('vi-VN', options)}</p>
                    </div>
                `,
                    icon: 'success',
                    timer: 5000,
                    showConfirmButton: true
                });

                setTimeout(() => {
                    employeeSelect.value = '';
                    startBtn.disabled = true;
                }, 5000);
            } else {
                Swal.fire({
                    title: 'ƒêƒÉng k√Ω th·∫•t b·∫°i',
                    html: `
                    <p><strong>L·ªói:</strong> ${data.error}</p>
                    <p class="mt-2">Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra c√°c ƒëi·ªÅu ki·ªán sau:</p>
                    <ul class="text-start">
                        <li>√Ånh s√°ng ƒë·∫ßy ƒë·ªß</li>
                        <li>Khu√¥n m·∫∑t n·∫±m trong khung h√¨nh</li>
                        <li>Kh√¥ng c√≥ v·∫≠t c·∫£n che khu√¥n m·∫∑t</li>
                        <li>L√†m ƒë√∫ng theo h∆∞·ªõng d·∫´n t∆∞ th·∫ø</li>
                    </ul>
                `,
                    icon: 'error'
                });
            }
        } catch (err) {
            console.error("Error registering faces:", err);
            Swal.fire({
                title: 'L·ªói h·ªá th·ªëng',
                text: `ƒê√£ x·∫£y ra l·ªói khi ƒëƒÉng k√Ω khu√¥n m·∫∑t: ${err.message}`,
                icon: 'error'
            });
        } finally {
            captureBtn.style.display = 'none';
            startBtn.style.display = 'inline-block';
            startBtn.disabled = false;
            poseFeedbackDiv.style.display = 'none';
            poseInstructionDiv.textContent = 'Ch·ªçn nh√¢n vi√™n v√† nh·∫•n "B·∫Øt ƒë·∫ßu thu th·∫≠p"';
            poseInstructionDiv.style.backgroundColor = '';
            poseInstructionDiv.className = 'alert alert-primary mt-2';
            overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
            allCaptures = [];
            currentStageIndex = 0;
            currentStageCaptures = 0;
            updateProgress();
        }
    }

    // Kh·ªüi t·∫°o camera khi trang ƒë∆∞·ª£c load
    document.addEventListener('DOMContentLoaded', initCamera);

    // Enable/disable n√∫t b·∫Øt ƒë·∫ßu d·ª±a tr√™n vi·ªác ch·ªçn nh√¢n vi√™n
    employeeSelect.addEventListener('change', () => {
        startBtn.disabled = !employeeSelect.value;
    });

    // X·ª≠ l√Ω s·ª± ki·ªán n√∫t b·∫Øt ƒë·∫ßu thu th·∫≠p
    startBtn.addEventListener('click', startCapturing);
</script>
{% endblock %}